AWSTemplateFormatVersion: '2010-09-09'
Transform: AWS::Serverless-2016-10-31

Globals:
  Function:
    Runtime: nodejs16.x
    Timeout: 10
    MemorySize: 512
  Api:
    Cors:
      AllowOrigin: "'*'"
      AllowMethods: "'*'"
      AllowHeaders: "'*'"

Resources:
  # General Api Gateway
  MyS3Api:
    Type: 'AWS::Serverless::Api'
    Properties:
      Name: !Sub "${AWS::StackName}-temp" 
      StageName: Test
      Cors:
        AllowOrigin: "'*'"
        AllowMethods: "'*'"
        AllowHeaders: "'*'"
      BinaryMediaTypes:
        - '*/*'

  # Photo service
  PhotoBucket:
    Type: 'AWS::S3::Bucket'
    Properties:
      BucketName: !Sub "${AWS::StackName}-data"
      BucketEncryption:
        ServerSideEncryptionConfiguration:
          - ServerSideEncryptionByDefault:
              SSEAlgorithm: AES256
      PublicAccessBlockConfiguration:
        BlockPublicAcls: true
        BlockPublicPolicy: true
        IgnorePublicAcls: true
        RestrictPublicBuckets: true

  RestApi:
    Type: AWS::Serverless::Function
    Properties:
      CodeUri: healthphotos/
      Handler: app.handler
      Runtime: nodejs16.x
      Environment:
        Variables:
          BUCKET_NAME: !Ref PhotoBucket
      Policies: AmazonS3FullAccess
      Events:
        GetHealthphoto:
          Type: Api
          Properties:
            RestApiId: !Ref MyS3Api
            Path: /healthphotos/{id}
            Method: any
        GetRoot:
          Type: Api
          Properties:
            RestApiId: !Ref MyS3Api
            Path: /healthphotos/
            Method: get
        PostRoot:
          Type: Api
          Properties:
            RestApiId: !Ref MyS3Api
            Path: /healthphotos/
            Method: post

  # Patient service
  PatientTable:
    Type: AWS::Serverless::SimpleTable

  Patient:
    Type: AWS::Serverless::Function
    Properties:
      CodeUri: patient/
      Handler: app.handler
      Runtime: nodejs16.x
      Environment:
        Variables:
          TABLE_NAME: !Ref PatientTable
      Policies: AmazonDynamoDBFullAccess
      Events:
        AddPatient:
          Type: Api
          Properties:
            Path: /patients
            Method: post
            RestApiId: !Ref MyS3Api
        ListPatient:
          Type: Api
          Properties:
            Path: /patients
            Method: get
            RestApiId: !Ref MyS3Api
        Patient:
          Type: Api
          Properties:
            Path: /patients/{id}
            Method: any
            RestApiId: !Ref MyS3Api

  # csv archive service
  CsvBucket:
    Type: 'AWS::S3::Bucket'
    Properties:
      BucketName: !Sub "${AWS::StackName}-csv-archive"
      BucketEncryption:
        ServerSideEncryptionConfiguration:
          - ServerSideEncryptionByDefault:
              SSEAlgorithm: AES256
      PublicAccessBlockConfiguration:
        BlockPublicAcls: true
        BlockPublicPolicy: true
        IgnorePublicAcls: true
        RestrictPublicBuckets: true

  CsvApi:
    Type: AWS::Serverless::Function
    Properties:
      CodeUri: csv-archive/
      Handler: app.handler
      Runtime: nodejs16.x
      Environment:
        Variables:
          BUCKET_NAME: !Ref CsvBucket
      Policies: AmazonS3FullAccess
      Events:
        GetCsvItem:
          Type: Api
          Properties:
            RestApiId: !Ref MyS3Api
            Path: /csv-archive/{id}
            Method: any
        GetCsvRoot:
          Type: Api
          Properties:
            RestApiId: !Ref MyS3Api
            Path: /csv-archive/
            Method: get
        PostCsvRoot:
          Type: Api
          Properties:
            RestApiId: !Ref MyS3Api
            Path: /csv-archive/
            Method: post

  PrivacyAccessPoint:
    Type: AWS::CloudFormation::Stack
    Properties:
      TemplateURL: "../privacy-component/output-template.yaml"
      Parameters:
        S3BucketName: !Ref CsvBucket

Outputs:
  HealthPhotoRestApiUrl:
    Description: "Severless REST api for health photos"
    Value: !Sub  "https://${MyS3Api}.execute-api.${AWS::Region}.amazonaws.com/Test/healthphotos/"
  PatientRestApiUrl:
    Description: "Severless REST api for patient data"
    Value: !Sub  "https://${MyS3Api}.execute-api.${AWS::Region}.amazonaws.com/Test/csv-archive/"